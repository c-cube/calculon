<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Plugin (calculon.Calculon.Plugin)</title><link rel="stylesheet" href="../../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 2.1.0"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">calculon</a> &#x00BB; <a href="../index.html">Calculon</a> &#x00BB; Plugin</nav><header class="odoc-preamble"><h1>Module <code><span>Calculon.Plugin</span></code></h1></header><nav class="odoc-toc"><ul><li><a href="#plugins">Plugins</a></li></ul></nav><div class="odoc-content"><h2 id="plugins"><a href="#plugins" class="anchor"></a>Plugins</h2><p>A plugin is a bunch of commands, and optionally some disk-backed state. It will register its commands to the core loop</p><div class="odoc-spec"><div class="spec type" id="type-json" class="anchored"><a href="#type-json" class="anchor"></a><code><span><span class="keyword">type</span> json</span><span> = <span class="xref-unresolved">Yojson</span>.Safe.t</span></code></div></div><div class="odoc-spec"><div class="spec type" id="type-action" class="anchored"><a href="#type-action" class="anchor"></a><code><span><span class="keyword">type</span> action</span><span> = </span></code><table><tr id="type-action.Require_reload" class="anchored"><td class="def variant constructor"><a href="#type-action.Require_reload" class="anchor"></a><code><span>| </span><span><span class="constructor">Require_reload</span></span></code></td><td class="def-doc"><span class="comment-delim">(*</span><p>Require that we reload everything from on-disk state</p><span class="comment-delim">*)</span></td></tr><tr id="type-action.Require_save" class="anchored"><td class="def variant constructor"><a href="#type-action.Require_save" class="anchor"></a><code><span>| </span><span><span class="constructor">Require_save</span></span></code></td><td class="def-doc"><span class="comment-delim">(*</span><p>Require that the state be saved</p><span class="comment-delim">*)</span></td></tr></table></div></div><div class="odoc-spec"><div class="spec type" id="type-action_callback" class="anchored"><a href="#type-action_callback" class="anchor"></a><code><span><span class="keyword">type</span> action_callback</span><span> = <span><a href="#type-action">action</a> <a href="../Signal/Send_ref/index.html#type-t">Signal.Send_ref.t</a></span></span></code></div></div><div class="odoc-spec"><div class="spec type" id="type-stateful" class="anchored"><a href="#type-stateful" class="anchor"></a><code><span><span class="keyword">type</span> stateful</span><span> = </span></code><table><tr id="type-stateful.St" class="anchored"><td class="def variant constructor"><a href="#type-stateful.St" class="anchor"></a><code><span>| </span><span><span class="constructor">St</span> : <span><span class="type-var">'st</span> <a href="#type-stateful_">stateful_</a></span> <span class="arrow">&#45;&gt;</span> <a href="#type-stateful">stateful</a></span></code></td></tr></table></div><div class="spec-doc"><p>A stateful plugin, using a persistent state <code>'st</code></p></div></div><div class="odoc-spec"><div class="spec type" id="type-stateful_" class="anchored"><a href="#type-stateful_" class="anchor"></a><code><span><span class="keyword">and</span> <span>'st stateful_</span></span><span> = <span class="keyword">private</span> </span><span>{</span></code><table><tr id="type-stateful_.name" class="anchored"><td class="def record field"><a href="#type-stateful_.name" class="anchor"></a><code><span>name : string;</span></code></td><td class="def-doc"><span class="comment-delim">(*</span><p>Namespace for storing state. Must be distinct for every plugin.</p><span class="comment-delim">*)</span></td></tr><tr id="type-stateful_.commands" class="anchored"><td class="def record field"><a href="#type-stateful_.commands" class="anchor"></a><code><span>commands : <span><span class="type-var">'st</span> <span class="arrow">&#45;&gt;</span></span> <span><a href="../Command/index.html#type-t">Command.t</a> list</span>;</span></code></td><td class="def-doc"><span class="comment-delim">(*</span><p>Commands parametrized by some (mutable) state, with the ability to trigger a signal</p><span class="comment-delim">*)</span></td></tr><tr id="type-stateful_.on_msg" class="anchored"><td class="def record field"><a href="#type-stateful_.on_msg" class="anchor"></a><code><span>on_msg : <span><span class="type-var">'st</span> <span class="arrow">&#45;&gt;</span></span> <span><span>( <span><a href="../Core/index.html#type-t">Core.t</a> <span class="arrow">&#45;&gt;</span></span> <span><span class="xref-unresolved">Irc_message</span>.t <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span> )</span> list</span>;</span></code></td><td class="def-doc"><span class="comment-delim">(*</span><p>Executed on each incoming message</p><span class="comment-delim">*)</span></td></tr><tr id="type-stateful_.to_json" class="anchored"><td class="def record field"><a href="#type-stateful_.to_json" class="anchor"></a><code><span>to_json : <span><span class="type-var">'st</span> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-json">json</a> option</span>;</span></code></td><td class="def-doc"><span class="comment-delim">(*</span><p>How to serialize (part of) the state into JSON, if need be.</p><span class="comment-delim">*)</span></td></tr><tr id="type-stateful_.of_json" class="anchored"><td class="def record field"><a href="#type-stateful_.of_json" class="anchor"></a><code><span>of_json : <span><a href="#type-action_callback">action_callback</a> <span class="arrow">&#45;&gt;</span></span> <span><span><a href="#type-json">json</a> option</span> <span class="arrow">&#45;&gt;</span></span> <span><span>( <span class="type-var">'st</span>, string )</span> <span class="xref-unresolved">Result</span>.result</span>;</span></code></td><td class="def-doc"><span class="comment-delim">(*</span><p>How to deserialize the state. <code>None</code> is passed for a fresh initialization.</p><span class="comment-delim">*)</span></td></tr><tr id="type-stateful_.stop" class="anchored"><td class="def record field"><a href="#type-stateful_.stop" class="anchor"></a><code><span>stop : <span><span class="type-var">'st</span> <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span>;</span></code></td><td class="def-doc"><span class="comment-delim">(*</span><p>Stop the plugin. It is NOT the responsibility of this command to save the state, as the core engine will have called <a href="#type-stateful_.to_json"><code>to_json</code></a> before.</p><span class="comment-delim">*)</span></td></tr></table><code><span>}</span></code></div></div><div class="odoc-spec"><div class="spec type" id="type-db_backed" class="anchored"><a href="#type-db_backed" class="anchor"></a><code><span><span class="keyword">type</span> db_backed</span><span> = <span class="keyword">private</span> </span><span>{</span></code><table><tr id="type-db_backed.commands" class="anchored"><td class="def record field"><a href="#type-db_backed.commands" class="anchor"></a><code><span>commands : <span><span class="xref-unresolved">Calculon</span>.DB_utils.DB.db <span class="arrow">&#45;&gt;</span></span> <span><a href="../Command/index.html#type-t">Command.t</a> list</span>;</span></code></td><td class="def-doc"><span class="comment-delim">(*</span><p>Commands parametrized by some (mutable) state, with the ability to trigger a signal</p><span class="comment-delim">*)</span></td></tr><tr id="type-db_backed.prepare_db" class="anchored"><td class="def record field"><a href="#type-db_backed.prepare_db" class="anchor"></a><code><span>prepare_db : <span><span class="xref-unresolved">Calculon</span>.DB_utils.DB.db <span class="arrow">&#45;&gt;</span></span> unit;</span></code></td><td class="def-doc"><span class="comment-delim">(*</span><p>Prepare database (create tables, etc.). Must be idempotent as it'll be called every time the plugin is initialized.</p><span class="comment-delim">*)</span></td></tr><tr id="type-db_backed.on_msg" class="anchored"><td class="def record field"><a href="#type-db_backed.on_msg" class="anchor"></a><code><span>on_msg : <span><span class="xref-unresolved">Calculon</span>.DB_utils.DB.db <span class="arrow">&#45;&gt;</span></span>
  <span><span>( <span><a href="../Core/index.html#type-t">Core.t</a> <span class="arrow">&#45;&gt;</span></span> <span><span class="xref-unresolved">Irc_message</span>.t <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span> )</span> list</span>;</span></code></td><td class="def-doc"><span class="comment-delim">(*</span><p>Executed on each incoming message</p><span class="comment-delim">*)</span></td></tr><tr id="type-db_backed.stop" class="anchored"><td class="def record field"><a href="#type-db_backed.stop" class="anchor"></a><code><span>stop : <span><span class="xref-unresolved">Calculon</span>.DB_utils.DB.db <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span>;</span></code></td><td class="def-doc"><span class="comment-delim">(*</span><p>Stop the plugin. There is no need to close the DB connection.</p><span class="comment-delim">*)</span></td></tr></table><code><span>}</span></code></div></div><div class="odoc-spec"><div class="spec type" id="type-t" class="anchored"><a href="#type-t" class="anchor"></a><code><span><span class="keyword">type</span> t</span><span> = <span class="keyword">private</span> </span></code><table><tr id="type-t.Stateful" class="anchored"><td class="def variant constructor"><a href="#type-t.Stateful" class="anchor"></a><code><span>| </span><span><span class="constructor">Stateful</span> <span class="keyword">of</span> <a href="#type-stateful">stateful</a></span></code></td></tr><tr id="type-t.Stateless" class="anchored"><td class="def variant constructor"><a href="#type-t.Stateless" class="anchor"></a><code><span>| </span><span><span class="constructor">Stateless</span> <span class="keyword">of</span> <span><a href="../Command/index.html#type-t">Command.t</a> list</span></span></code></td></tr><tr id="type-t.DB_backed" class="anchored"><td class="def variant constructor"><a href="#type-t.DB_backed" class="anchor"></a><code><span>| </span><span><span class="constructor">DB_backed</span> <span class="keyword">of</span> <a href="#type-db_backed">db_backed</a></span></code></td></tr></table></div><div class="spec-doc"><p>A single plugin</p></div></div><div class="odoc-spec"><div class="spec type" id="type-plugin" class="anchored"><a href="#type-plugin" class="anchor"></a><code><span><span class="keyword">type</span> plugin</span><span> = <a href="#type-t">t</a></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-of_cmd" class="anchored"><a href="#val-of_cmd" class="anchor"></a><code><span><span class="keyword">val</span> of_cmd : <span><a href="../Command/index.html#type-t">Command.t</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-t">t</a></span></code></div><div class="spec-doc"><p>Stateless plugin with 1 command.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-of_cmds" class="anchored"><a href="#val-of_cmds" class="anchor"></a><code><span><span class="keyword">val</span> of_cmds : <span><span><a href="../Command/index.html#type-t">Command.t</a> list</span> <span class="arrow">&#45;&gt;</span></span> <a href="#type-t">t</a></span></code></div><div class="spec-doc"><p>Stateless plugin with several commands.</p><ul class="at-tags"><li class="raises"><span class="at-tag">raises</span> <span class="value">Invalid_argument</span> <p>if the list is empty</p></li></ul></div></div><div class="odoc-spec"><div class="spec value" id="val-stateful" class="anchored"><a href="#val-stateful" class="anchor"></a><code><span><span class="keyword">val</span> stateful : 
  <span>name:string <span class="arrow">&#45;&gt;</span></span>
  <span>commands:<span>( <span><span class="type-var">'st</span> <span class="arrow">&#45;&gt;</span></span> <span><a href="../Command/index.html#type-t">Command.t</a> list</span> )</span> <span class="arrow">&#45;&gt;</span></span>
  <span>?on_msg:<span>( <span><span class="type-var">'st</span> <span class="arrow">&#45;&gt;</span></span> <span><span>( <span><a href="../Core/index.html#type-t">Core.t</a> <span class="arrow">&#45;&gt;</span></span> <span><span class="xref-unresolved">Irc_message</span>.t <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span> )</span> list</span> )</span> <span class="arrow">&#45;&gt;</span></span>
  <span>to_json:<span>( <span><span class="type-var">'st</span> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-json">json</a> option</span> )</span> <span class="arrow">&#45;&gt;</span></span>
  <span>of_json:<span>( <span><a href="#type-action_callback">action_callback</a> <span class="arrow">&#45;&gt;</span></span> <span><span><a href="#type-json">json</a> option</span> <span class="arrow">&#45;&gt;</span></span> <span><span>( <span class="type-var">'st</span>, string )</span> <span class="xref-unresolved">Result</span>.result</span> )</span> <span class="arrow">&#45;&gt;</span></span>
  <span>?stop:<span>( <span><span class="type-var">'st</span> <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span> )</span> <span class="arrow">&#45;&gt;</span></span>
  <span>unit <span class="arrow">&#45;&gt;</span></span>
  <a href="#type-t">t</a></span></code></div><div class="spec-doc"><p>Make a stateful plugin using the given <code>name</code> (for prefixing its storage; this should be unique) and ways to serialize state to Json, deserialize state from Json, and building commands from the state. See <a href="#type-stateful_"><code>stateful_</code></a> for more details on each field.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-db_backed" class="anchored"><a href="#val-db_backed" class="anchor"></a><code><span><span class="keyword">val</span> db_backed : 
  <span>commands:<span>( <span><span class="xref-unresolved">Calculon</span>.DB_utils.DB.db <span class="arrow">&#45;&gt;</span></span> <span><a href="../Command/index.html#type-t">Command.t</a> list</span> )</span> <span class="arrow">&#45;&gt;</span></span>
  <span>prepare_db:<span>( <span><span class="xref-unresolved">Calculon</span>.DB_utils.DB.db <span class="arrow">&#45;&gt;</span></span> unit )</span> <span class="arrow">&#45;&gt;</span></span>
  <span>?on_msg:
    <span>( <span><span class="xref-unresolved">Calculon</span>.DB_utils.DB.db <span class="arrow">&#45;&gt;</span></span>
      <span><span>( <span><a href="../Core/index.html#type-t">Core.t</a> <span class="arrow">&#45;&gt;</span></span> <span><span class="xref-unresolved">Irc_message</span>.t <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span> )</span> list</span> )</span> <span class="arrow">&#45;&gt;</span></span>
  <span>?stop:<span>( <span><span class="xref-unresolved">Calculon</span>.DB_utils.DB.db <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span> )</span> <span class="arrow">&#45;&gt;</span></span>
  <span>unit <span class="arrow">&#45;&gt;</span></span>
  <a href="#type-t">t</a></span></code></div><div class="spec-doc"><p>Make a stateful plugin that is backed by some tables in the database. See <a href="#val-db_backed"><code>db_backed</code></a> for more details.</p><ul class="at-tags"><li class="since"><span class="at-tag">since</span> NEXT_RELEASE</li></ul></div></div><div class="odoc-spec"><div class="spec module" id="module-Set" class="anchored"><a href="#module-Set" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Set/index.html">Set</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div></div></body></html>